<% include("cbi/map") %>
<style>
.announcement-banner {
    display: none;
    background-color: #1080c1;
    color: white;
    padding: 8px;
    margin-bottom: 10px;
    margin-left: auto;
    margin-right: auto;
    border-radius: 4px;
    overflow: hidden;
    position: relative;
    height: 24px;
    width: 35%;
}

.announcement-content {
    position: absolute;
    white-space: nowrap;
    padding-right: 50px;
    left: 30px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 1;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 14px;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

.megaphone-icon {
    position: absolute;
    left: 8px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 2;
    font-size: 16px;
    color: white;
}

.megaphone-container {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 30px;
    background-color: #1080c1;
    z-index: 2;
    border-top-left-radius: 4px;
    border-bottom-left-radius: 4px;
}

.warning-text {
    color: #ffeb3b;
}

.success-text {
    color: #ffffff;
    font-weight: 500;
}
</style>

<div id="announcement-banner" class="announcement-banner">
    <div class="megaphone-container"></div>
    <span id="megaphone-icon" class="megaphone-icon">📢</span>
    <div id="announcement-content" class="announcement-content"></div>
</div>

<script type="text/javascript">
	function _id2section(id) {
		var x = id.split(".");
		return x[2];
	}

	function onclick_awake(id) {
		var section = _id2section(id);
		var btnXHR = new XHR();
		btnXHR.post('<%=url([[admin]], [[services]], [[wolplus]], [[awake]])%>/' + section, { token: '<%=token%>' },
			function(x, data) {
				if (x.responseText == "_uncommitted_") {
					showAnnouncement("<%:Please [Save & Apply] your changes first%>", "warning");
				} else {
					var response = JSON.parse(x.response).data;
					// 提取MAC地址
					var macMatch = response.match(/address is ([0-9A-Fa-f:]+)/);
					if (macMatch && macMatch[1]) {
						var mac = macMatch[1];
						// 获取设备名称
						var nameXHR = new XHR();
						nameXHR.get('<%=url([[admin]], [[services]], [[wolplus]], [[get_name]])%>/' + section, null,
							function(x, data) {
								if (x && x.status == 200 && data.name) {
									showAnnouncement("已向设备" + data.name + "（" + mac + "）发送远程唤醒包。", "success");
								} else {
									showAnnouncement("已向设备（" + mac + "）发送远程唤醒包。", "success");
								}
							}
						);
					} else {
						showAnnouncement(response, "success");
					}
				}
			}
		);
	}

	// 滚动字幕相关函数
	var banner = document.getElementById('announcement-banner');
	var content = document.getElementById('announcement-content');
	var megaphoneIcon = document.getElementById('megaphone-icon');
	var isPaused = false;
	var currentIndex = 0;
	var announcements = [];
	var position = 0;
	var speed = 1.5;
	var pauseCounter = 0;
	var pauseDuration = 20;

	function showAnnouncement(message, type) {
		announcements = [message];
		banner.style.display = 'block';
		currentIndex = 0;
		content.textContent = announcements[currentIndex];
		
		// 根据类型设置样式
		if (type === "warning") {
			megaphoneIcon.textContent = "⚠️";
			content.className = "announcement-content warning-text";
		} else {
			megaphoneIcon.textContent = "📢";
			content.className = "announcement-content success-text";
		}
		
		var bannerWidth = banner.offsetWidth;
		var contentWidth = content.offsetWidth;
		position = bannerWidth;
		
		startScrolling();
	}

	function startScrolling() {
		function moveText() {
			if (!isPaused) {
				if (position < -content.offsetWidth && pauseCounter >= pauseDuration) {
					currentIndex = (currentIndex + 1) % announcements.length;
					content.textContent = announcements[currentIndex];
					position = banner.offsetWidth;
					pauseCounter = 0;
				} 
				else if (position < -content.offsetWidth) {
					pauseCounter++;
				}
				else {
					position -= speed;
				}
				
				content.style.left = position + 'px';
			}
			
			requestAnimationFrame(moveText);
		}
		
		moveText();
	}

	// 鼠标悬停暂停
	banner.addEventListener('mouseenter', function() {
		isPaused = true;
	});
	
	banner.addEventListener('mouseleave', function() {
		isPaused = false;
	});
</script>
